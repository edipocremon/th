<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>3 Hydrological Analysis | TerraHidro User Manual</title>
  <meta name="description" content="The TerraHidro Manual is a practical, task-oriented guide to hydrological and geomorphometric processing with TerraHidro. It covers setup (Command-Line Interface and QGIS plugin), required data formats, and step-by-step workflows to build a hydrologically conditioned DEM. Each tool includes concise theory, parameters, command examples, and figures, followed by end-to-end examples for flow direction, contributing area, drainage/watershed delineation, and export for GIS." />
  <meta name="generator" content="bookdown 0.44 and GitBook 2.6.7" />

  <meta property="og:title" content="3 Hydrological Analysis | TerraHidro User Manual" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="/fig/logo_terrahidro.jpg" />
  <meta property="og:description" content="The TerraHidro Manual is a practical, task-oriented guide to hydrological and geomorphometric processing with TerraHidro. It covers setup (Command-Line Interface and QGIS plugin), required data formats, and step-by-step workflows to build a hydrologically conditioned DEM. Each tool includes concise theory, parameters, command examples, and figures, followed by end-to-end examples for flow direction, contributing area, drainage/watershed delineation, and export for GIS." />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="3 Hydrological Analysis | TerraHidro User Manual" />
  
  <meta name="twitter:description" content="The TerraHidro Manual is a practical, task-oriented guide to hydrological and geomorphometric processing with TerraHidro. It covers setup (Command-Line Interface and QGIS plugin), required data formats, and step-by-step workflows to build a hydrologically conditioned DEM. Each tool includes concise theory, parameters, command examples, and figures, followed by end-to-end examples for flow direction, contributing area, drainage/watershed delineation, and export for GIS." />
  <meta name="twitter:image" content="/fig/logo_terrahidro.jpg" />

<meta name="author" content="Division of Earth Observation and Geoinformatics - DIOTG" />


<meta name="date" content="2025-10-21" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="introduction.html"/>
<link rel="next" href="how-to-cite.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">TerraHidro User Manual</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Preface</a></li>
<li class="chapter" data-level="2" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>2</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#project-highlights"><i class="fa fa-check"></i>Project Highlights</a></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#downloading-terrahidro"><i class="fa fa-check"></i>Downloading TerraHidro</a></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#command-line-interface"><i class="fa fa-check"></i>Command-Line Interface</a>
<ul>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#example-removing-pits-with-the-pfs-operation"><i class="fa fa-check"></i>Example: Removing Pits with the <code>pfs</code> Operation</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#qgis-plugin-installation-and-setup"><i class="fa fa-check"></i>QGIS Plugin Installation and Setup</a>
<ul>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#installing-the-terrahidro-plugin-in-qgis"><i class="fa fa-check"></i>Installing the TerraHidro Plugin in QGIS</a></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#configuring-the-terrahidro-environment-variable-windows"><i class="fa fa-check"></i>Configuring the <code>TERRAHIDRO</code> Environment Variable (Windows)</a></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#final-step"><i class="fa fa-check"></i>Final Step</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html"><i class="fa fa-check"></i><b>3</b> Hydrological Analysis</a>
<ul>
<li class="chapter" data-level="3.1" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#DEM-Pre-processing-and-Correction"><i class="fa fa-check"></i><b>3.1</b> DEM Pre-processing and Correction</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#simplepits"><i class="fa fa-check"></i><b>3.1.1</b> simplepits</a></li>
<li class="chapter" data-level="3.1.2" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#agreedem"><i class="fa fa-check"></i><b>3.1.2</b> agreedem</a></li>
<li class="chapter" data-level="3.1.3" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#flatareas"><i class="fa fa-check"></i><b>3.1.3</b> flatareas</a></li>
<li class="chapter" data-level="3.1.4" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#carvev"><i class="fa fa-check"></i><b>3.1.4</b> carvev</a></li>
<li class="chapter" data-level="3.1.5" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#carve"><i class="fa fa-check"></i><b>3.1.5</b> carve</a></li>
<li class="chapter" data-level="3.1.6" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#fill"><i class="fa fa-check"></i><b>3.1.6</b> fill</a></li>
<li class="chapter" data-level="3.1.7" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#pfs"><i class="fa fa-check"></i><b>3.1.7</b> pfs</a></li>
<li class="chapter" data-level="3.1.8" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#pfsd"><i class="fa fa-check"></i><b>3.1.8</b> pfsd</a></li>
<li class="chapter" data-level="3.1.9" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#removepits"><i class="fa fa-check"></i><b>3.1.9</b> removepits</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#Flow-Analysis-Drainage-Network-Extraction-and-Characterization"><i class="fa fa-check"></i><b>3.2</b> Flow Analysis, Drainage Network Extraction and Characterization</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#d8"><i class="fa fa-check"></i><b>3.2.1</b> d8</a></li>
<li class="chapter" data-level="3.2.2" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#d8toupstream"><i class="fa fa-check"></i><b>3.2.2</b> d8toupstream</a></li>
<li class="chapter" data-level="3.2.3" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#d8ca"><i class="fa fa-check"></i><b>3.2.3</b> d8ca</a></li>
<li class="chapter" data-level="3.2.4" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#d8drainage"><i class="fa fa-check"></i><b>3.2.4</b> d8drainage</a></li>
<li class="chapter" data-level="3.2.5" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#d8drainagev"><i class="fa fa-check"></i><b>3.2.5</b> d8drainagev</a></li>
<li class="chapter" data-level="3.2.6" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#flowpath"><i class="fa fa-check"></i><b>3.2.6</b> flowpath</a></li>
<li class="chapter" data-level="3.2.7" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#segments"><i class="fa fa-check"></i><b>3.2.7</b> segments</a></li>
<li class="chapter" data-level="3.2.8" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#outletbasin"><i class="fa fa-check"></i><b>3.2.8</b> outletbasin</a></li>
<li class="chapter" data-level="3.2.9" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#mainriver"><i class="fa fa-check"></i><b>3.2.9</b> mainriver</a></li>
<li class="chapter" data-level="3.2.10" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#shreve"><i class="fa fa-check"></i><b>3.2.10</b> shreve</a></li>
<li class="chapter" data-level="3.2.11" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#strahler"><i class="fa fa-check"></i><b>3.2.11</b> strahler</a></li>
<li class="chapter" data-level="3.2.12" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#ottorivers"><i class="fa fa-check"></i><b>3.2.12</b> ottorivers</a></li>
<li class="chapter" data-level="3.2.13" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#mouths"><i class="fa fa-check"></i><b>3.2.13</b> mouths</a></li>
<li class="chapter" data-level="3.2.14" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#orderedmouths"><i class="fa fa-check"></i><b>3.2.14</b> orderedmouths</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#Basin-and-Sub-basin-Delineation"><i class="fa fa-check"></i><b>3.3</b> Basin and Sub-basin Delineation</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#minibasins"><i class="fa fa-check"></i><b>3.3.1</b> minibasins</a></li>
<li class="chapter" data-level="3.3.2" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#outletbasin"><i class="fa fa-check"></i><b>3.3.2</b> outletbasin</a></li>
<li class="chapter" data-level="3.3.3" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#ottobasins"><i class="fa fa-check"></i><b>3.3.3</b> ottobasins</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#Geomorphometric-analysis"><i class="fa fa-check"></i><b>3.4</b> Geomorphometric analysis</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#tpi"><i class="fa fa-check"></i><b>3.4.1</b> tpi</a></li>
<li class="chapter" data-level="3.4.2" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#hand"><i class="fa fa-check"></i><b>3.4.2</b> hand</a></li>
<li class="chapter" data-level="3.4.3" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#sand"><i class="fa fa-check"></i><b>3.4.3</b> sand</a></li>
<li class="chapter" data-level="3.4.4" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#d8slope"><i class="fa fa-check"></i><b>3.4.4</b> d8slope</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#Applied-Hydrology-Risk-Management"><i class="fa fa-check"></i><b>3.5</b> Applied Hydrology &amp; Risk Management</a>
<ul>
<li class="chapter" data-level="3.5.1" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#gfplain"><i class="fa fa-check"></i><b>3.5.1</b> gfplain</a></li>
<li class="chapter" data-level="3.5.2" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#damcourse"><i class="fa fa-check"></i><b>3.5.2</b> damcourse</a></li>
<li class="chapter" data-level="3.5.3" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#damsections"><i class="fa fa-check"></i><b>3.5.3</b> damsections</a></li>
<li class="chapter" data-level="3.5.4" data-path="hydrological-analysis.html"><a href="hydrological-analysis.html#dambreak"><i class="fa fa-check"></i><b>3.5.4</b> dambreak</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="how-to-cite.html"><a href="how-to-cite.html"><i class="fa fa-check"></i><b>4</b> How to Cite</a>
<ul>
<li class="chapter" data-level="" data-path="how-to-cite.html"><a href="how-to-cite.html#apa"><i class="fa fa-check"></i>APA</a></li>
<li class="chapter" data-level="" data-path="how-to-cite.html"><a href="how-to-cite.html#bibtex"><i class="fa fa-check"></i>BibTeX</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">TerraHidro User Manual</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="hydrological-analysis" class="section level1 hasAnchor" number="3">
<h1><span class="header-section-number">3</span> Hydrological Analysis<a href="hydrological-analysis.html#hydrological-analysis" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="DEM-Pre-processing-and-Correction" class="section level2 hasAnchor" number="3.1">
<h2><span class="header-section-number">3.1</span> DEM Pre-processing and Correction<a href="hydrological-analysis.html#DEM-Pre-processing-and-Correction" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This group of algorithms is designed to transform a raw Digital Elevation Model (DEM) into a hydrologically correct surface where water can flow uninterrupted to the watershed outlet. It addresses common DEM errors like pits (depressions), flat areas, and misalignments with known river networks. The output is a “pitless” and “conditioned” DEM that is essential for accurate flow direction, watershed delineation, and subsequent hydrological analysis.</p>
<ul>
<li><a href="hydrological-analysis.html#simplepits">simplepits</a></li>
<li><a href="hydrological-analysis.html#agreedem">agreedem</a></li>
<li><a href="hydrological-analysis.html#flatareas">flatareas</a></li>
<li><a href="hydrological-analysis.html#carvev">carvev</a></li>
<li><a href="hydrological-analysis.html#carve">carve</a></li>
<li><a href="hydrological-analysis.html#fill">fill</a></li>
<li><a href="hydrological-analysis.html#pfs">pfs</a></li>
<li><a href="hydrological-analysis.html#pfsd">pfsd</a></li>
<li><a href="hydrological-analysis.html#removepits">removepits</a></li>
</ul>
<div id="simplepits" class="section level3 hasAnchor" number="3.1.1">
<h3><span class="header-section-number">3.1.1</span> simplepits<a href="hydrological-analysis.html#simplepits" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>simplepits</code> is an initial, targeted step for removing hydrological depressions (pits) from a Digital Elevation Model (DEM) while keeping changes to the terrain as small as possible. In pit removal there are three general strategies—fill, carve/breach, or hybrid. Filling is the simplest, but applying it indiscriminately can trigger a cascade: fixing one pit creates new pits in neighboring cells, which leads to further fills and can produce artificial flat areas that were not present in the original DEM. To avoid this, <code>simplepits</code> focuses only on simple pits — those that can be eliminated by a single, localized elevation increase without causing any neighboring cell to become a new pit. The algorithm proceeds with a controlled trial-and-error step: it tentatively raises the pit cell by a small amount, checks the surrounding cells, and accepts the change only if no new pits appear. If any adjacent cell becomes a pit, the change is reverted and that cell is labeled a complex pit to be handled later. Operationally, it runs in linear time with respect to the number of pit cells and is intended as a conservative first pass before more comprehensive conditioning.</p>
<p>In TerraHidro there are two functionalities for pit removal: <code>simplepits</code> and <a href="hydrological-analysis.html#pfs"><code>pfs</code></a>. The <code>simplepits</code> functionality modifies only the pit cell. A new elevation is assigned to that cell based on the lowest neighboring elevation plus a predefined increment (in practice, <code>1e-3</code>). After this increment is applied, all neighboring cells** of the pit must be checked to ensure that no new pits were created. If none of the neighbors becomes a pit, the original pit is considered resolved by a simple, local operation and is classified as a simple pit. If any neighbor becomes a pit, the modification is undone and that pit cell is deferred to <code>pfs</code>, which handles complex pits.</p>
<p><img src="fig/simplepits.png" />
<strong>Figure - Simple pit resolution (a–b).</strong> (a) Initial DEM with pit cell C2 (orange) and D8 flow directions (blue). (b) C2 is raised to the lowest neighboring cell (D3) by a small increment, eliminating the pit without creating adjacent pits; the edit is accepted as a simple-pit case. Source: Jardim (2017).</p>
<table>
<thead>
<tr class="header">
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>dem</code></td>
<td>Input raster DEM file <em>(e.g.,inputDEM.tif)</em></td>
</tr>
<tr class="even">
<td><code>output</code></td>
<td>Output raster file <em>(e.g., <code>outputDEM.tif</code>)</em></td>
</tr>
</tbody>
</table>
<p>The following example demonstrates how to use <code>simplepits</code> tool from the command line:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="hydrological-analysis.html#cb5-1" tabindex="-1"></a><span class="ex">th</span> simplepits inputDEM.tif outputDEM.tif</span></code></pre></div>
<p><em>Reference</em>:</p>
<p>Jardim, A. C. (2017). <em>Direções de fluxo em modelos digitais de elevação: um método com foco na qualidade da estimativa e processamento de grande volume de dados</em> [Doctoral dissertation, Instituto Nacional de Pesquisas Espaciais (INPE)]. <a href="http://mtc-m21b.sid.inpe.br/col/sid.inpe.br/mtc-m21b/2017/05.17.13.26/doc/publicacao.pdf?metadatarepository=sid.inpe.br/mtc-m21b/2017/05.17.13.26.57&amp;mirror=sid.inpe.br/mtc-m21b/2013/09.26.14.25.22&amp;languagebutton=en">https://sid.inpe.br/mtc-m21b/2017/05.17.13.26</a></p>
<p><em>See also</em>: <a href="hydrological-analysis.html#pfs">pfs</a>, <a href="hydrological-analysis.html#removepits">removepits</a>.</p>
</div>
<div id="agreedem" class="section level3 hasAnchor" number="3.1.2">
<h3><span class="header-section-number">3.1.2</span> agreedem<a href="hydrological-analysis.html#agreedem" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>agreedem</code> modifies a Digital Elevation Model (DEM) in and around a known drainage network to improve the agreement between automatically derived flow directions and observed/reference channels. When the drainage extracted from a raw DEM does not align with mapped streams, <code>agreedem</code> “guides” flow by sharpening (trenching/burning) the elevations along the reference network and optionally smoothing the surrounding cells within a distance buffer. This targeted editing is especially effective over low-relief and flat areas, where automatic drainage extraction is most ambiguous and computationally costly (see Clarke &amp; Burnett, 2003).</p>
<p><code>agreedem</code> is <strong>not</strong> a complete pit/flat conditioning method on its own. It only edits elevations on the reference lines and nearby cells; therefore, a hydrologically conditioned DEM (HC-DEM) still requires flat-area handling** and <strong>pit removal</strong> (e.g., <code>simplepits</code> then <code>pfs</code>) so that D8 flow directions are defined everywhere. In practice, drainage data are supplied as vector lines and first converted to a raster grid; each stream cell receives an assigned “burn” value (stream burning; Wang et al., 2011), producing a gridded drainage mask that <code>agreedem</code> uses together with the original DEM.</p>
<p>The reconditioning occurs in two coupled steps:</p>
<ul>
<li><strong>Sharpening (trenching/burning):</strong> a fixed decrement is subtracted from the elevation of every drainage cell to carve a narrow channel along the reference lines. This intentionally introduces artificial micro-valleys that act as <strong>flow guides</strong> for automatic extraction.</li>
<li><strong>Smoothing (buffered taper):</strong> within a user-defined buffer radius (in cells) around the drainage, additional decrements are applied that decrease with distance from the line (distance-weighted). This creates a small stepped cross-section that transitions the trench back to the surrounding terrain, reducing artifacts and improving convergence of flow to the channel.</li>
</ul>
<p><img src="fig/th_agreedem.png" /></p>
<p><strong>Figure 3.1. Reconditioning (AgreeDEM).</strong> Cross-section example showing a 3×3 buffer where the nearest ring to the channel receives the largest decrement, the next ring a smaller decrement, and so on; the drainage cells themselves receive a larger <strong>burn</strong> depth. (Illustrative values follow the narrative.)</p>
<blockquote>
<p><strong>Workflow note.</strong> After running <code>agreedem</code>, proceed with <strong>flat-area</strong> and <strong>pit</strong> resolution (e.g., <code>flatareas</code> → <code>simplepits</code> → <code>pfs</code>) to obtain a final HC-DEM suitable for D8 flow direction, contributing area, and watershed delineation.</p>
</blockquote>
<hr />
<p><strong>Parameters</strong></p>
<table>
<colgroup>
<col width="8%" />
<col width="91%" />
</colgroup>
<thead>
<tr class="header">
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>dem</code></td>
<td>Input DEM raster file (GeoTIFF) (e.g., <em>inputDEM.tif</em>).</td>
</tr>
<tr class="even">
<td><code>drainage</code></td>
<td>Input drainage network (vector <code>.shp</code> or raster grid). Vector lines are rasterized internally/externally to a grid for stream burning (e.g., <em>inputDrainage.shp</em>).</td>
</tr>
<tr class="odd">
<td><code>burn</code></td>
<td>Trench depth applied to drainage cells (fixed decrement), e.g., <code>50</code>.</td>
</tr>
<tr class="even">
<td><code>buffer</code></td>
<td>Buffer radius in cells around drainage for smoothing (distance-weighted taper), e.g., <code>3</code>.</td>
</tr>
<tr class="odd">
<td><code>smooth</code></td>
<td>Smoothing factor that scales decrements within the buffer (larger values yield stronger taper near the channel), e.g., <code>10</code>.</td>
</tr>
<tr class="even">
<td><code>burn-only</code></td>
<td>Optional switch to disable smoothing and apply trenching only on drainage cells.</td>
</tr>
<tr class="odd">
<td><code>-output</code></td>
<td>Output reconditioned DEM (GeoTIFF) (e.g., <em>outputDEM.tif</em>).</td>
</tr>
</tbody>
</table>
<p>The following example demonstrates how to use <code>agreedem</code> tool from the command line:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="hydrological-analysis.html#cb6-1" tabindex="-1"></a><span class="ex">th</span> agreedem inputDEM.tif inputDrainage.shp BURN BUFFER SMOOTH outputDEM.tif</span></code></pre></div>
<p>Example (illustrative):</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="hydrological-analysis.html#cb7-1" tabindex="-1"></a><span class="ex">th</span> agreedem inputDEM.tif inputDrainage.shp 20 3 10 outputDEM.tif</span></code></pre></div>
<p><em>Reference</em>:</p>
<p>Clarke, S., &amp; Burnett, K. (2003). Comparison of digital elevation models for aquatic data development. Photogrammetric Engineering &amp; Remote Sensing, 69(12), 1367-1375. <a href="https://doi.org/10.14358/PERS.69.12.1367">https://doi.org/10.14358/PERS.69.12.1367</a></p>
<p>Wang, J., Li, L., Hao, Z., &amp; Gourley, J. J. (2011). Stream guiding algorithm for deriving flow direction from DEM and location of main streams. IAHS-AISH Publication, 346, 198-205.</p>
<p><em>See also</em>: <a href="hydrological-analysis.html#pfsd">pfsd</a>.</p>
</div>
<div id="flatareas" class="section level3 hasAnchor" number="3.1.3">
<h3><span class="header-section-number">3.1.3</span> flatareas<a href="hydrological-analysis.html#flatareas" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><em>flatareas</em> identifies contiguous regions of uniform elevation within a Digital Elevation Model (DEM). The tool scans the input raster for adjacent cells possessing identical elevation values. It then groups these cells into distinct flat features.</p>
<p>The algorithm requires a user-defined minimum area threshold, specified as a number of cells. This parameter excludes smaller, potentially insignificant flat zones from the output. The result is a raster layer where each flat area is classified, providing a basis for subsequent hydrological conditioning procedures.</p>
<p><code>flatareas</code> identifies flat areas—contiguous clusters of cells with the same elevation—and outputs a raster mask to be used in the next step (carving) so that flow lines can pass through the center of wide rivers and large flats. Flat areas are common in DEMs such as SRTM, AW3D30, and Copernicus DEM where river widths exceed grid resolution; they often appear as a “staircase” along the longitudinal profile, and every cell within a flat behaves like a pit, increasing the cost of hydrologic conditioning. By first mapping these flats, subsequent processing can dig a V-shaped channel from the edges toward the center, reducing the number of pits and guiding drainage.</p>
<p>The original detection approach uses a simple image filter rather than an expensive region-growing segmentation. The filter has two parts: an inner 3×3 square (central test) and an outer cross (expansion). The kernel is swept from the upper-left to the lower-right of the DEM. At each position, if all cells in the inner square share the central cell’s elevation, then any cells in the outer cross that also match are marked as flat. Cells with invalid/NoData elevation (e.g., ocean mask values such as <code>-32768</code>) are ignored. This produces large connected flat patches efficiently. In Figure below (Identifying flat areas), intermediate steps (e.g., 26a and 26b) show the inner test and subsequent marking; by the final pass (step 112) most flat cells are identified. A few unmarked cells may remain, but they do not affect the next stage, which carves these flats.</p>
<p>An enhanced variant uses a breadth-first flood fill (8-connected: orthogonal and diagonal neighbors), starting from each valid cell, to visit all equal-elevation neighbors exactly once. This ensures complete detection with <span class="math inline">\(O(n)\)</span> complexity (each DEM cell is processed once) and naturally selects diagonal borders as well as orthogonal ones. After each component is discovered, it is retained as a flat area only if it meets the minimum size (cell count) specified by the user.</p>
<p><img src="fig/th_flatareas.png" />
<strong>Figure 3.2. Identifying flat areas.</strong> DEM cells with distinct elevations (brown) surround a flat river reach (white); gray cells are invalid/NoData (e.g., ocean/border). The 3×3 inner square (red) and outer cross (green) filter identify and mark the flat region (orange). By step 112, nearly all flat cells are tagged; any remaining unmarked cells are corrected during the subsequent carving stage. Source: Jardim (2017).</p>
<hr />
<p><strong>Parameters</strong></p>
<table>
<colgroup>
<col width="13%" />
<col width="86%" />
</colgroup>
<thead>
<tr class="header">
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>dem</code></td>
<td>Input DEM raster (GeoTIFF), e.g., <code>inputDEM.tif</code>.</td>
</tr>
<tr class="even">
<td><code>min-cells</code></td>
<td>Positive integer for the minimum contiguous cell count required to classify a region as a flat area.</td>
</tr>
<tr class="odd">
<td><code>output</code></td>
<td>Output flat-areas mask (GeoTIFF), e.g., <code>outputFlatAreas.tif</code> (e.g., 1 = flat, 0 = non-flat).</td>
</tr>
</tbody>
</table>
<p>The following example demonstrates how to use <code>flatareas</code> tool from the command line:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="hydrological-analysis.html#cb8-1" tabindex="-1"></a><span class="ex">th</span> flatareas inputDEM.tif MINCELLS outputFlatAreas.tif</span></code></pre></div>
<p>Example:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="hydrological-analysis.html#cb9-1" tabindex="-1"></a><span class="ex">th</span> flatareas inputDEM.tif 25 outputFlatAreas.tif</span></code></pre></div>
<p><em>Reference</em>:</p>
<p>Jardim, A. C. (2017). <em>Direções de fluxo em modelos digitais de elevação: um método com foco na qualidade da estimativa e processamento de grande volume de dados</em> [Doctoral dissertation, Instituto Nacional de Pesquisas Espaciais (INPE)]. <a href="http://mtc-m21b.sid.inpe.br/col/sid.inpe.br/mtc-m21b/2017/05.17.13.26/doc/publicacao.pdf?metadatarepository=sid.inpe.br/mtc-m21b/2017/05.17.13.26.57&amp;mirror=sid.inpe.br/mtc-m21b/2013/09.26.14.25.22&amp;languagebutton=en">https://sid.inpe.br/mtc-m21b/2017/05.17.13.26</a></p>
<p><em>See also</em>: <a href="hydrological-analysis.html#carvev">carvev</a>, <a href="hydrological-analysis.html#carve">carve</a>.</p>
</div>
<div id="carvev" class="section level3 hasAnchor" number="3.1.4">
<h3><span class="header-section-number">3.1.4</span> carvev<a href="hydrological-analysis.html#carvev" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>carvev</code> detects flat areas in a DEM and carves them from the borders toward the center to form a V-shaped cross-section, guiding drainage through the midline of wide rivers and extensive flats. Unlike workflows that first require an explicit flat-area mask, <code>carvev</code> identifies flats internally and then performs the carving step; you do not need to run <code>flatareas</code> beforehand.</p>
<p>The algorithm first locates the orthogonal border of each flat (only horizontal/vertical adjacencies are considered borders; neighbors marked as invalid/NoData—e.g., ocean or DEM edges—are not treated as borders). It then decrements the elevation of all border cells by a small initial step and removes those cells from the flat set. The process repeats in rounds, each time re-identifying the new orthogonal border and applying decrements, progressively moving inward until no flat cells remain. This produces a stepped V profile: higher steps at the outer edges, lower steps toward the center, so that subsequent flow-direction and contributing-area calculations follow the centerline of the river/plain rather than hugging one bank. Special handling avoids carving from ocean/border toward the interior, preventing unrealistic flow from sea to land.</p>
<p>This pre-processing drastically reduces the number of pits in flats and accelerates downstream conditioning: after <code>carvev</code>, only a smaller set of residual depressions typically remains for <code>simplepits</code> and <code>pfs</code>, improving both robustness and performance.</p>
<p><img src="fig/th_carvev.png" />
<strong>Figure - Demonstration of V-shaped carving of flat areas</strong>. (a) Identify flats and their <strong>orthogonal borders</strong>; (b–e) iteratively decrement border elevations and move inward, forming a stepped V profile centered on the flat’s midline.</p>
<hr />
<p><strong>Parameters</strong></p>
<table>
<colgroup>
<col width="14%" />
<col width="85%" />
</colgroup>
<thead>
<tr class="header">
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>dem</code></td>
<td>Input DEM raster (GeoTIFF), e.g., <em>(e.g.,inputDEM.tif)</em>.</td>
</tr>
<tr class="even">
<td><code>output</code></td>
<td>Output DEM (GeoTIFF) with flat areas carved in V-shape <em>(e.g., <code>outputDEM.tif</code>)</em>.</td>
</tr>
</tbody>
</table>
<p>The following example demonstrates how to use <code>carvev</code> tool from the command line:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="hydrological-analysis.html#cb10-1" tabindex="-1"></a><span class="ex">th</span> carvev inputDEM.tif outputDEM.tif</span></code></pre></div>
<p><em>Reference</em>:</p>
<p>Jardim, A. C. (2017). <em>Direções de fluxo em modelos digitais de elevação: um método com foco na qualidade da estimativa e processamento de grande volume de dados</em> [Doctoral dissertation, Instituto Nacional de Pesquisas Espaciais (INPE)]. <a href="http://mtc-m21b.sid.inpe.br/col/sid.inpe.br/mtc-m21b/2017/05.17.13.26/doc/publicacao.pdf?metadatarepository=sid.inpe.br/mtc-m21b/2017/05.17.13.26.57&amp;mirror=sid.inpe.br/mtc-m21b/2013/09.26.14.25.22&amp;languagebutton=en">https://sid.inpe.br/mtc-m21b/2017/05.17.13.26</a></p>
<p><em>See also</em>: <a href="hydrological-analysis.html#flatareas">flatareas</a>, <a href="hydrological-analysis.html#carve">carve</a>.</p>
</div>
<div id="carve" class="section level3 hasAnchor" number="3.1.5">
<h3><span class="header-section-number">3.1.5</span> carve<a href="hydrological-analysis.html#carve" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>carve</code> removes flat areas from a DEM by carving a gentle slope inside the flat mask produced by <code>flatareas</code>, optionally guided by a reference drainage network (vector or raster). In contrast to <code>carvev</code> (which converges toward the geometric center of the flat), <code>carve</code> can force the lowest elevations to align with mapped channels, producing flow paths that better match observed hydrography.</p>
<blockquote>
<p><strong>Workflow requirement.</strong> Run <code>flatareas</code> first to generate the flat-area raster; pass this raster to <code>carve</code> together with the original DEM and the reference drainage network (if used).</p>
</blockquote>
<p><strong>How it works (summary).</strong><br />
1) From the input flat-area mask, <code>carve</code> selects the border cells of each flat region according to a user-chosen neighborhood (orthogonal, diagonal, or all directions).<br />
2) If a reference drainage is enabled, cells on the drainage within the flat are treated as the lowest targets, so the carving preferentially guides slopes toward the mapped channel.<br />
3) The algorithm iteratively decrements border elevations and re-identifies new borders, moving inward like a stepped V-profile until the flat is removed. If drainage is not used, the carving converges toward the center (behavior similar to <code>carvev</code>).<br />
4) Any remaining uncarved flat cells at the end are adjusted with the last decrement step; if drainage is active, stream cells receive the smallest (lowest) elevation to ensure convergence to the channel.</p>
<p><img src="fig/th_carve.png" />
<strong>Figure - Comparison of the final stage between <code>carvev</code> and <code>carve</code></strong>. (a) original V-shaped notch (<code>carvev</code>, centered), (b) improved notch (<code>carve</code>, aligned with the reference drainage), the green pixels correspond to a reference drainage.</p>
<hr />
<p><strong>Parameters</strong></p>
<table>
<colgroup>
<col width="8%" />
<col width="91%" />
</colgroup>
<thead>
<tr class="header">
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>dem</code></td>
<td>Input DEM (GeoTIFF) (e.g., <em>inputDEM.tif</em>).</td>
</tr>
<tr class="even">
<td><code>drainage</code></td>
<td>Input reference drainage (vector <code>.shp</code> or raster). When enabled (<code>DRNON</code>), carving aligns the lowest elevations with the drainage inside each flat. If disabled (<code>DRNOFF</code>), carving converges toward the center (like <code>carvev</code>).</td>
</tr>
<tr class="odd">
<td><code>--flat</code></td>
<td>Input flat-areas raster (GeoTIFF) produced by <code>flatareas</code> (e.g., <em>inputFlatAreas.tif</em>). <strong>Required.</strong></td>
</tr>
<tr class="even">
<td><code>DRNON | DRNOFF</code></td>
<td>Use drainage? <code>DRNON</code> = use drainage to guide carving; <code>DRNOFF</code> = do not use drainage (center-focused carving).</td>
</tr>
<tr class="odd">
<td><code>CROSS | DIAG | ALL</code></td>
<td>Border-definition rule for each iteration: <code>CROSS</code> = orthogonal neighbors; <code>DIAG</code> = diagonal neighbors; <code>ALL</code> = eight-direction neighbors.</td>
</tr>
<tr class="even">
<td><code>-o, --output</code></td>
<td>Output DEM (GeoTIFF) with flat areas carved (e.g., <em>outputDEM.tif</em>).</td>
</tr>
</tbody>
</table>
<p>The following example demonstrates how to use <code>carve</code> tool from the command line:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="hydrological-analysis.html#cb11-1" tabindex="-1"></a><span class="ex">th</span> carve inputDEM.tif inputDrainage.shp inputFlatAreas.tif DRNON<span class="kw">|</span><span class="ex">DRNOFF</span> CROSS<span class="kw">|</span><span class="ex">DIAG</span><span class="kw">|</span><span class="ex">ALL</span> outputDEM.tif</span></code></pre></div>
<p>Example (illustrative):</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="hydrological-analysis.html#cb12-1" tabindex="-1"></a><span class="ex">th</span> carve inputDEM.tif inputDrainage.shp FlatAreas.tif DRNON ALL outputDEM.tif</span></code></pre></div>
<p><strong>Author</strong>: Dr. Henrique Rennó de Azeredo Freitas</p>
<p><em>See also</em>: <a href="hydrological-analysis.html#flatareas">flatareas</a>, <a href="hydrological-analysis.html#carvev">carvev</a>.</p>
</div>
<div id="fill" class="section level3 hasAnchor" number="3.1.6">
<h3><span class="header-section-number">3.1.6</span> fill<a href="hydrological-analysis.html#fill" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>fill</code> repairs missing-data holes (voids/NoData) in a DEM by fusing it with a reference DEM that provides elevation inside the voids. The tool uses a separate, often coarser-resolution, reference DEM to supply elevation values for these regions. This is <strong>not</strong> the same as the “fill sinks” hydrologic operation found in SAGA GIS, GRASS, etc.<br />
- This tool: fills voids where the DEM has no data (e.g., SRTM gaps).<br />
- Fill sinks (other software): alters elevations to remove hydrologic depressions in valid data.<br />
Use <code>fill</code> early in the workflow to produce a complete, gap-free DEM before hydrologic conditioning (<code>agreedem</code>, <code>flatareas</code>/<code>carve</code> or <code>carvev</code>, <code>simplepits</code>, <code>pfs</code>, etc.).</p>
<p><strong>How it works (summary).</strong><br />
<code>fill</code> implements a modified Delta Surface Fill (Grohman et al., 2006): it derives a smooth difference (“delta”) between overlapping, valid portions of the input DEM and the reference DEM, then uses that delta to blend elevations seamlessly inside voids so that transitions at void boundaries are undetectable.</p>
<blockquote>
<p><strong>Best practices.</strong> Make sure the input and reference DEMs are in the same projection.</p>
</blockquote>
<hr />
<p><strong>Parameters</strong></p>
<table>
<colgroup>
<col width="19%" />
<col width="80%" />
</colgroup>
<thead>
<tr class="header">
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>dem</code></td>
<td>Input DEM (GeoTIFF) with voids (e.g., <em>inputDEM.tif</em>).</td>
</tr>
<tr class="even">
<td><code>reference</code></td>
<td>Reference DEM (GeoTIFF) that supplies elevations inside voids (e.g., <em>referenceDEM.tif</em>).</td>
</tr>
<tr class="odd">
<td><code>output</code></td>
<td>Output void-filled DEM (GeoTIFF) (e.g., <em>outputDEM.tif</em>).</td>
</tr>
</tbody>
</table>
<p>The following example demonstrates how to use <code>fill</code> tool from the command line:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="hydrological-analysis.html#cb13-1" tabindex="-1"></a><span class="ex">th</span> fill inputDEM.tif referenceDEM.tif outputDEM.tif</span></code></pre></div>
<p><em>Reference</em>:</p>
<p>Grohman, G., Kroenung, G. and Strebeck, J., 2006. Filling SRTM voids: The delta surface fill method. Photogrammetric Engineering and Remote Sensing, 72(3), pp.213-216.</p>
<p><em>See also</em>: <a href="hydrological-analysis.html#simplepits">simplepits</a>, <a href="hydrological-analysis.html#removepits">removepits</a>.</p>
</div>
<div id="pfs" class="section level3 hasAnchor" number="3.1.7">
<h3><span class="header-section-number">3.1.7</span> pfs<a href="hydrological-analysis.html#pfs" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><em>pfs</em> removes depressions from a Digital Elevation Model (DEM) using a priority-first search algorithm. The tool initiates a grid search from each pit cell to locate the nearest spill point with a lower elevation. It employs a priority queue to evaluate potential paths, constructing a descending elevation trajectory to the outlet.</p>
<p>This process modifies cell values along the selected path to create a hydrologically continuous surface. The algorithm ensures all depressions are resolved, producing a pit-free DEM suitable for subsequent flow-direction analysis.</p>
<p><code>pfs</code> removes all remaining depressions from a DEM by carving a path from each pit cell to an outlet cell using a <strong>Priority-First Search (PFS)</strong>. Unlike <code>simplepits</code>, which changes only the pit cell, <code>pfs</code> modifies the elevations of multiple cells along a selected path so that flow can proceed continuously from the original pit to a lower cell. To minimize DEM alteration, the path is chosen to be as short as possible toward the lowest reachable elevation; if no valid interior cell is found first, the path may end at an invalid cell or at the DEM border.</p>
<p>The DEM is treated as a graph in which each grid cell is a node and neighborhood relations (typically 8-connected) are edges. Starting at the pit (initial node), PFS explores neighboring cells using a priority queue ordered by desirability—first by lower elevation, and, in case of ties, by shorter path length from the pit. As cells are visited, the algorithm maintains a tree of paths (parent–child relations) that encodes all partial routes under consideration. When PFS reaches a final cell that satisfies the stop criteria (lower elevation and shortest distance), it commits the path from the pit to that outlet and proceeds to modify the DEM along that path.</p>
<p><img src="fig/th_pfs1.png" />
<strong>Figure - PFS search to remove a pit.</strong> The priority queue tracks, for each visited cell, its elevation, the number of steps from the pit (path length), and its parent. The final path (e.g., B2–C2–D3–D4) is committed and marked in the path tree (Jardim, 2017).</p>
<p>Elevation modification is applied by creating a linear downslope along the chosen path: moving outward from the pit, each intermediate cell along the route receives an elevation slightly lower than its predecessor, using a small decrement step (in practice, <code>1e-3</code>) applied cell by cell; the first (pit) and last (outlet) cells are not adjusted. This yields a gentle carved profile that preserves local relief while ensuring drainage continuity. To prevent creating a new pit near the outlet, PFS includes a stop condition that guarantees the computed elevation at the cell before the outlet will still be higher than the outlet’s elevation given the cumulative decrements; otherwise, the route is rejected and search continues. Border or invalid cells may also serve as terminating outlets under the stop criteria.</p>
<p><img src="fig/th_pfs_grid.png" />
<strong>Figure - DEM modification by a linear slope</strong> . Example before (a) and after (b) applying a constant decrement along the committed path (illustrated here with a larger step of <code>1e-1</code> for clarity), leaving the pit and outlet cells unaltered (Jardim, 2017).</p>
<p>In practice, <code>pfs</code> complements <code>simplepits</code>: simple depressions are removed first with single-cell fills; complex ones are then resolved by PFS carving. The result is a pitless DEM suitable for reliable flow-direction, contributing-area, and drainage-network derivations, with minimal distortion relative to the original topography.</p>
<table>
<thead>
<tr class="header">
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>dem</code></td>
<td>Input raster DEM file <em>(e.g.,inputDEM.tif)</em></td>
</tr>
<tr class="even">
<td><code>output</code></td>
<td>Output raster file <em>(e.g., <code>outputDEM.tif</code>)</em></td>
</tr>
</tbody>
</table>
<p>The following example demonstrates how to use <code>simplepits</code> tool from the command line:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="hydrological-analysis.html#cb14-1" tabindex="-1"></a><span class="ex">th</span> pfs inputDEM.tif outputDEM.tif</span></code></pre></div>
<p><em>Reference</em>:</p>
<p>Jones, R. (2002). Algorithms for using a DEM for mapping catchment areas of stream sediment samples. Computers &amp; geosciences, v. 28, n. 9, p. 1051–1060. <a href="https://doi.org/10.1016/S0098-3004(02)00022-5">https://doi.org/10.1016/S0098-3004(02)00022-5</a></p>
<p>Jardim, A. C. (2017). <em>Direções de fluxo em modelos digitais de elevação: um método com foco na qualidade da estimativa e processamento de grande volume de dados</em> [Doctoral dissertation, Instituto Nacional de Pesquisas Espaciais (INPE)]. <a href="http://mtc-m21b.sid.inpe.br/col/sid.inpe.br/mtc-m21b/2017/05.17.13.26/doc/publicacao.pdf?metadatarepository=sid.inpe.br/mtc-m21b/2017/05.17.13.26.57&amp;mirror=sid.inpe.br/mtc-m21b/2013/09.26.14.25.22&amp;languagebutton=en">https://sid.inpe.br/mtc-m21b/2017/05.17.13.26</a></p>
<p><em>See also</em>: <a href="hydrological-analysis.html#simplepits">simplepits</a>, <a href="hydrological-analysis.html#removepits">removepits</a>.</p>
</div>
<div id="pfsd" class="section level3 hasAnchor" number="3.1.8">
<h3><span class="header-section-number">3.1.8</span> pfsd<a href="hydrological-analysis.html#pfsd" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>pfsd</code> removes all remaining pits by carving paths to outlet cells using the same <strong>Priority-First Search (PFS)</strong> algorithm implemented in <code>pfs</code>, with one key enhancement: processing is seeded from the reference drainage network and proceeds upstream into adjacent depressions. By anchoring the search to mapped channels, <code>pfsd</code> accelerates convergence, improves path selection near wide flats, and yields a pitless DEM whose drainage is consistent with observed hydrography.</p>
<p><strong>How it works (summary).</strong><br />
- Treat the DEM as a graph (cells = nodes; 8-connected neighbors = edges).<br />
- Initialize the PFS frontier on drainage cells (vector lines rasterized internally if needed).<br />
- For each encountered pit, build a candidate tree of paths ordered by lower elevation and, on ties, shorter distance to the channel; commit the first path that satisfies the outlet criteria.<br />
- Carve a gentle linear downslope along the committed path (small per-cell decrements), ensuring continuous flow from the pit to the outlet without over-smoothing.<br />
- Iterate upstream until no depressions remain.</p>
<p><strong>When to use.</strong> Choose <code>pfsd</code> when a reference drainage is available and you want pit removal to follow mapped channels. For projects without a drainage reference, use <code>pfs</code>.</p>
<hr />
<div class="callout-note">
<p><strong>Workflow note.</strong> A common conditioning chain is:
<code>agreedem</code> (optional) → <code>flatareas</code> + <code>carve</code> (or <code>carvev</code>) → <code>simplepits</code> → <strong><code>pfsd</code></strong>.
Using <code>pfsd</code> at the end aligns remaining pit removal with the reference drainage, improving hydrologic realism and efficiency.</p>
</div>
<p><strong>Parameters</strong></p>
<table>
<colgroup>
<col width="16%" />
<col width="83%" />
</colgroup>
<thead>
<tr class="header">
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>-dem</code></td>
<td>Input DEM (GeoTIFF) (e.g., <em>inputDEM.tif</em>).</td>
</tr>
<tr class="even">
<td><code>drainage</code></td>
<td>Reference drainage network (vector <code>.shp</code> or raster). Used to seed PFS from channels upstream.</td>
</tr>
<tr class="odd">
<td><code>-output</code></td>
<td>Output pitless DEM (GeoTIFF) after PFS carving (e.g., <em>outputDEM.tif</em>).</td>
</tr>
</tbody>
</table>
<p>The following example demonstrates how to use <code>pfsd</code> tool from the command line:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="hydrological-analysis.html#cb15-1" tabindex="-1"></a><span class="ex">th</span> pfsd inputDEM.tif inputDrainage.shp outputDEM.tif</span></code></pre></div>
<p><em>Reference</em>:</p>
<p>Jones, R. (2002). Algorithms for using a DEM for mapping catchment areas of stream sediment samples. Computers &amp; geosciences, v. 28, n. 9, p. 1051–1060. <a href="https://doi.org/10.1016/S0098-3004(02)00022-5">https://doi.org/10.1016/S0098-3004(02)00022-5</a></p>
<p><em>Author</em>: Dr. Henrique Rennó de Azeredo Freitas</p>
<p><em>See also</em>: <a href="hydrological-analysis.html#pfs">pfs</a>, <a href="hydrological-analysis.html#removepits">removepits</a>.</p>
</div>
<div id="removepits" class="section level3 hasAnchor" number="3.1.9">
<h3><span class="header-section-number">3.1.9</span> removepits<a href="hydrological-analysis.html#removepits" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>removepits</code> performs a full hydrologic correction of a DEM using a hybrid approach that both fills and carves where appropriate, minimizing unnecessary elevation changes while ensuring continuous drainage. It is the preferred one-pass procedure when you want a pitless DEM without supplying a reference drainage network.</p>
<p><strong>What it does (three phases).</strong><br />
<code>removepits</code> internally executes, in sequence:</p>
<ol style="list-style-type: decimal">
<li><strong><code>carvev</code></strong> — identifies flat areas and carves them <em>V-shaped</em> from the borders toward the center, guiding flow through the flat midline and drastically reducing the number of depressions in these regions;<br />
</li>
<li><strong><code>simplepits</code></strong> — applies selective single-cell filling to remove only those depressions that can be fixed by a minimal local raise without creating new pits;<br />
</li>
<li><strong><code>pfs</code></strong> — uses Priority-First Search to carve a gentle downslope path from any remaining (complex) pits to an outlet cell, completing the elimination of depressions.</li>
</ol>
<p>By combining targeted fill sinks (phase 2) with controlled carving (phases 1 and 3), <code>removepits</code> is a <strong>hybrid method</strong> designed to preserve local relief while producing reliable D8 flow directions across the entire grid.</p>
<hr />
<p><strong>Parameters</strong></p>
<table>
<colgroup>
<col width="13%" />
<col width="86%" />
</colgroup>
<thead>
<tr class="header">
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>dem</code></td>
<td>Input DEM (GeoTIFF) (e.g., <em>inputDEM.tif</em>).</td>
</tr>
<tr class="even">
<td><code>output</code></td>
<td>Output pitless DEM (GeoTIFF) with flats carved and simple/complex pits removed (<em>e.g., outputDEM.tif</em>).</td>
</tr>
</tbody>
</table>
<p>The following example demonstrates how to use <code>removepits</code> tool from the command line:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="hydrological-analysis.html#cb16-1" tabindex="-1"></a><span class="ex">th</span> removepits inputDEM.tif outputDEM.tif</span></code></pre></div>
<p><em>Reference</em>:</p>
<p>Jardim, A. C. (2017). <em>Direções de fluxo em modelos digitais de elevação: um método com foco na qualidade da estimativa e processamento de grande volume de dados</em> [Doctoral dissertation, Instituto Nacional de Pesquisas Espaciais (INPE)]. <a href="http://mtc-m21b.sid.inpe.br/col/sid.inpe.br/mtc-m21b/2017/05.17.13.26/doc/publicacao.pdf?metadatarepository=sid.inpe.br/mtc-m21b/2017/05.17.13.26.57&amp;mirror=sid.inpe.br/mtc-m21b/2013/09.26.14.25.22&amp;languagebutton=en">https://sid.inpe.br/mtc-m21b/2017/05.17.13.26</a></p>
<p><em>See also</em>: <a href="hydrological-analysis.html#carvev">carvev</a>, <a href="hydrological-analysis.html#simplepits">simplepits</a>, <a href="hydrological-analysis.html#pfs">pfs</a>.</p>
</div>
</div>
<div id="Flow-Analysis-Drainage-Network-Extraction-and-Characterization" class="section level2 hasAnchor" number="3.2">
<h2><span class="header-section-number">3.2</span> Flow Analysis, Drainage Network Extraction and Characterization<a href="hydrological-analysis.html#Flow-Analysis-Drainage-Network-Extraction-and-Characterization" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li><a href="hydrological-analysis.html#d8">d8</a><br />
</li>
<li><a href="hydrological-analysis.html#d8ca">d8ca</a><br />
</li>
<li><a href="hydrological-analysis.html#d8drainage">d8drainage</a><br />
</li>
<li><a href="hydrological-analysis.html#d8drainagev">d8drainagev</a></li>
<li><a href="hydrological-analysis.html#flowpath">flowpath</a></li>
<li><a href="hydrological-analysis.html#segments">segments</a><br />
</li>
<li><a href="hydrological-analysis.html#outletbasin">outletbasin</a><br />
</li>
<li><a href="hydrological-analysis.html#mainriver">mainriver</a><br />
</li>
<li><a href="hydrological-analysis.html#shreve">shreve</a><br />
</li>
<li><a href="hydrological-analysis.html#strahler">strahler</a><br />
</li>
<li><a href="hydrological-analysis.html#ottorivers">ottorivers</a><br />
</li>
<li><a href="hydrological-analysis.html#mouths">mouths</a><br />
</li>
<li><a href="hydrological-analysis.html#orderedmouths">orderedmouths</a></li>
<li><a href="hydrological-analysis.html#ottorivers">ottorivers</a></li>
</ul>
<div id="d8" class="section level3 hasAnchor" number="3.2.1">
<h3><span class="header-section-number">3.2.1</span> d8<a href="hydrological-analysis.html#d8" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>d8</code> computes the local drainage direction (flow direction) for each DEM cell using the classic <strong>D8</strong> method (O’Callaghan &amp; Mark, 1984). For every valid cell, the algorithm compares the eight neighbors and assigns the direction of steepest descent. Cells with no downslope neighbor (e.g., flats/pits not yet conditioned, borders, or NoData) receive 0.</p>
<blockquote>
<p><strong>Prerequisite.</strong> Use a hydrologically conditioned DEM (pitless and flat areas treated), typically produced with <code>removepits</code> (or the equivalent sequence <code>carvev</code> → <code>simplepits</code> → <code>pfs</code>, or <code>pfsd</code> when a reference drainage is used).</p>
</blockquote>
<p><strong>Direction codes (powers of two).</strong><br />
The output raster stores a power-of-two code indicating the outflow neighbor:</p>
<table>
<thead>
<tr class="header">
<th align="right">Code</th>
<th align="left">Direction</th>
<th align="left">Offset (row, col)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="left">E</td>
<td align="left">(0, +1)</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="left">SE</td>
<td align="left">(+1, +1)</td>
</tr>
<tr class="odd">
<td align="right">4</td>
<td align="left">S</td>
<td align="left">(+1, 0)</td>
</tr>
<tr class="even">
<td align="right">8</td>
<td align="left">SW</td>
<td align="left">(+1, −1)</td>
</tr>
<tr class="odd">
<td align="right">16</td>
<td align="left">W</td>
<td align="left">(0, −1)</td>
</tr>
<tr class="even">
<td align="right">32</td>
<td align="left">NW</td>
<td align="left">(−1, −1)</td>
</tr>
<tr class="odd">
<td align="right">64</td>
<td align="left">N</td>
<td align="left">(−1, 0)</td>
</tr>
<tr class="even">
<td align="right">128</td>
<td align="left">NE</td>
<td align="left">(−1, +1)</td>
</tr>
<tr class="odd">
<td align="right">0</td>
<td align="left">Invalid / No downslope / NoData</td>
<td align="left"></td>
</tr>
</tbody>
</table>
<p><img src="fig/th_d8_flow_directions.png" /></p>
<p><strong>Figure - Codes and corresponding flow directions (compass layout)</strong>.</p>
<blockquote>
<p><strong>Notes.</strong><br />
• Ties are uncommon after proper conditioning; if present, the tool resolves to one neighbor or yields 0 when no descent exists.<br />
• Cells touching NoData or the DEM boundary may legitimately output 0.<br />
• The D8 flow direction is the basis for contributing area, stream extraction, stream ordering, and watershed delineation.</p>
</blockquote>
<hr />
<p><strong>Parameters</strong></p>
<table>
<colgroup>
<col width="14%" />
<col width="85%" />
</colgroup>
<thead>
<tr class="header">
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>dem</code></td>
<td>Input hydrologically conditioned DEM (GeoTIFF) (e.g., <em>inputDEM.tif</em>).</td>
</tr>
<tr class="even">
<td><code>output</code></td>
<td>Output D8 flow direction raster (GeoTIFF) (e.g., <em>flowdir.tif</em>).</td>
</tr>
</tbody>
</table>
<p>The following example demonstrates how to use <code>d8</code> tool from the command line:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="hydrological-analysis.html#cb17-1" tabindex="-1"></a><span class="ex">th</span> d8 inputDEM.tif flowdir.tif</span></code></pre></div>
<p><em>Reference</em>:</p>
<p>O’Callaghan, J. F., &amp; Mark, D. M. (1984). The extraction of drainage networks from digital elevation data. Computer vision, graphics, and image processing, 28(3), 323-344.<a href="https://doi.org/10.1016/S0734-189X(84)80011-0">https://doi.org/10.1016/S0734-189X(84)80011-0</a></p>
<p><em>See also</em>: <a href="hydrological-analysis.html#d8ca">d8ca</a>.</p>
</div>
<div id="d8toupstream" class="section level3 hasAnchor" number="3.2.2">
<h3><span class="header-section-number">3.2.2</span> d8toupstream<a href="hydrological-analysis.html#d8toupstream" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>d8toupstream</code> derives an upstream-flow raster from a D8 flow-direction grid. While <code>d8</code> stores each cell’s outflow (steepest descent), <code>d8toupstream</code> encodes which neighbors flow into each cell. The encoding uses the D8 power-of-two scheme and writes, for every cell, the sum of the codes of downstream directions of its neighbors that point to it Cells with no inflow receive 0.</p>
<blockquote>
<p><strong>Why it matters.</strong> The D8 upstream flow directions grid is a <strong>key input</strong> for higher-level tools that trace channels or hierarchies upstream, such as: <code>rivers</code>, <code>ottorivers</code>, <code>ottobasins</code>, <code>mainriver</code>, <code>watercourses</code>, and <code>dambreak</code>.</p>
</blockquote>
<p><strong>Behavior (summary).</strong>
For each cell, inspect its eight neighbors. If a neighbor’s D8 flow-direction points to the current cell, add that neighbor’s direction code to the current cell’s value. The result compactly represents all inflowing directions (e.g., a confluence might store <code>2 + 64 = 66</code> for SE and N inflows).</p>
<blockquote>
<p><strong>Prerequisite.</strong> Use a hydrologically conditioned DEM to compute <code>d8</code> first (e.g., <code>removepits</code>). Ensure all rasters share the same extent, resolution, and alignment.</p>
</blockquote>
<hr />
<p><strong>Parameters</strong></p>
<table>
<colgroup>
<col width="12%" />
<col width="87%" />
</colgroup>
<thead>
<tr class="header">
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>d8</code></td>
<td>Input D8 flow-direction raster (GeoTIFF) (e.g., <em>inputD8.tif</em>).</td>
</tr>
<tr class="even">
<td><code>output</code></td>
<td>Output upstream-pointer raster (GeoTIFF) (e.g., <em>outputUpstream.tif</em> (sum of D8 codes of inflow cells)).</td>
</tr>
</tbody>
</table>
<p>The following example demonstrates how to use <code>d8toupstream</code> tool from the command line:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb18-1"><a href="hydrological-analysis.html#cb18-1" tabindex="-1"></a><span class="ex">th</span> d8toupstream inputD8.tif outputUpstream.tif</span></code></pre></div>
<p><em>See also</em>: <a href="hydrological-analysis.html#d8">d8</a>.</p>
</div>
<div id="d8ca" class="section level3 hasAnchor" number="3.2.3">
<h3><span class="header-section-number">3.2.3</span> d8ca<a href="hydrological-analysis.html#d8ca" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>d8ca</code> computes the contributing area (a.k.a. flow accumulation) by following a <strong>D8 flow-direction</strong> grid and counting how many cells drain to each location, including the cell itself (single-flow-direction; no divergence). This produces a raster in which hillslopes have small values and channels concentrate large values.</p>
<blockquote>
<p><strong>Prerequisite.</strong> Use a D8 flow-direction raster produced by <code>d8</code> from a hydrologically conditioned (pitless) DEM.</p>
</blockquote>
<p><img src="fig/th_d8ca.png" /></p>
<p><strong>Figure - Contributing area derived from a D8 grid.</strong></p>
<hr />
<p><strong>Behavior &amp; output</strong>
- Method: Single-flow-direction (<em>SFD</em>): each cell routes its discharge to one downslope neighbor (O’Callaghan &amp; Mark, 1984).<br />
- Default units: cell counts (number of upslope cells).<br />
- NoData handling: cells with NoData in the input D8 raster become NoData in the output.</p>
<hr />
<p><strong>Parameters</strong></p>
<table>
<colgroup>
<col width="13%" />
<col width="86%" />
</colgroup>
<thead>
<tr class="header">
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>input</code></td>
<td>Input D8 flow-direction raster (GeoTIFF) (e.g., <em>inputD8.tif</em>).</td>
</tr>
<tr class="even">
<td><code>output</code></td>
<td>Output D8 contributing area (GeoTIFF) (e.g., <em>outputD8ContributingArea.tif</em>).</td>
</tr>
</tbody>
</table>
<p>The following example demonstrates how to use <code>d8ca</code> tool from the command line:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="hydrological-analysis.html#cb19-1" tabindex="-1"></a><span class="ex">th</span> d8ca inputD8.tif outputD8ContributingArea.tif</span></code></pre></div>
<p><em>Reference</em>:</p>
<p>O’Callaghan, J. F., &amp; Mark, D. M. (1984). The extraction of drainage networks from digital elevation data. Computer vision, graphics, and image processing, 28(3), 323-344.<a href="https://doi.org/10.1016/S0734-189X(84)80011-0">https://doi.org/10.1016/S0734-189X(84)80011-0</a></p>
<p><em>See also</em>: <a href="hydrological-analysis.html#d8">d8</a>.</p>
</div>
<div id="d8drainage" class="section level3 hasAnchor" number="3.2.4">
<h3><span class="header-section-number">3.2.4</span> d8drainage<a href="hydrological-analysis.html#d8drainage" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>d8drainage</code> maps the drainage network by applying a threshold to a D8 contributing area raster (<code>d8ca</code>). Each cell is assigned 1 (stream) if its contributing area is greater than or equal to the specified threshold, and 0 otherwise. The result is a binary stream grid suitable for stream ordering, vectorization, and watershed delineation.</p>
<p><img src="fig/th_d8drainage.png" /></p>
<p><strong>Figure - Drainage network derived from a D8 contributing-area grid using a minimum-area threshold</strong>. (a) Threshold of 9 cells to initiate a channel; (b) Resulting binary raster of the extracted channel network.</p>
<blockquote>
<p><strong>Prerequisite.</strong> Use a contributing-area raster produced by <code>d8ca</code> from a hydrologically conditioned DEM and its corresponding <code>d8</code> flow directions.</p>
</blockquote>
<hr />
<p><strong>Choosing the threshold (guidance)</strong><br />
- The threshold represents the minimum upslope area needed to initiate/maintain a channel (area used as a surrogate for discharge).<br />
- Smaller thresholds ⇒ denser networks; larger thresholds ⇒ <em>parser</em> networks.<br />
- There is no universal value: it depends on <strong>terrain, climate, lithology, and </strong>grid resolution**.<br />
- Common practice: inspect maps/imagery, test a range of values, and select the one that best matches known channels.</p>
<p><strong>Behavior &amp; data handling</strong><br />
- Input NoData cells remain NoData in the output (not classified as streams).<br />
- Threshold is provided in cells (i.e., count of upslope cells).</p>
<hr />
<p><strong>Parameters</strong></p>
<table>
<colgroup>
<col width="14%" />
<col width="85%" />
</colgroup>
<thead>
<tr class="header">
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>input</code></td>
<td>Input D8 contributing area raster (GeoTIFF), (e.g. <em>inputContributingArea.tif</em>).</td>
</tr>
<tr class="even">
<td><code>output</code></td>
<td>Output binary drainage network raster (GeoTIFF) (e.g., <em>outputDrainage.tif</em> (1 = stream, 0 = non-stream).</td>
</tr>
<tr class="odd">
<td><code>thresholdValue</code></td>
<td>Minimum contributing area (in cells) to classify a cell as stream.</td>
</tr>
</tbody>
</table>
<p>The following example demonstrates how to use <code>d8ca</code> tool from the command line:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="hydrological-analysis.html#cb20-1" tabindex="-1"></a><span class="ex">th</span> d8drainage inputContributingArea.tif outputDrainage.tif thresholdValue</span></code></pre></div>
<p>Example:</p>
<pre><code>th d8drainage d8ca.tif drainage.tif 2000</code></pre>
<blockquote>
<p><strong>Tip</strong> Start with a broad sweep (e.g., 300, 500, 1000, 2000, 5000 cells), compare against known hydrography or high-resolution imagery, then refine the threshold for your study area..</p>
</blockquote>
<p><em>See also</em>: <a href="hydrological-analysis.html#d8">d8</a>, <a href="hydrological-analysis.html#d8ca">d8ca</a>.</p>
</div>
<div id="d8drainagev" class="section level3 hasAnchor" number="3.2.5">
<h3><span class="header-section-number">3.2.5</span> d8drainagev<a href="hydrological-analysis.html#d8drainagev" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>d8drainagev</code> converts a binary drainage raster (e.g., from <code>d8drainage</code>) into vector polylines by following the D8 flow-direction raster. The tool traverses stream cells from sources (no inflowing neighbors) downstream along the D8 directions, assembling connected cell pairs into line features that represent stream segments.</p>
<p><strong>How it works (summary).</strong><br />
- Reads the drainage raster (1 = stream, 0 = non-stream; NoData ignored) and the matching D8 direction raster.<br />
- Detects headwater cells (stream cells with no upstream contributors) and traces downstream paths by following the D8 pointer of each cell.<br />
- Builds polyline features for each connected path; branching and confluences are preserved by starting new lines as needed.<br />
- Outputs a vector line dataset suitable for ordering, attribution, and cartographic display.</p>
<hr />
<p><strong>Parameters</strong></p>
<table>
<colgroup>
<col width="16%" />
<col width="83%" />
</colgroup>
<thead>
<tr class="header">
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>drainage</code></td>
<td>Input <strong>drainage network</strong> raster (GeoTIFF), e.g., <code>inputDrainage.tif</code> (1 = stream, 0 = else).</td>
</tr>
<tr class="even">
<td><code>d8</code></td>
<td>Input <strong>D8 flow-direction</strong> raster (GeoTIFF), e.g., <code>inputD8.tif</code>.</td>
</tr>
<tr class="odd">
<td><code>output</code></td>
<td>Output <strong>vector drainage network</strong> (e.g., ESRI Shapefile), e.g., <code>outputDrainage.shp</code>.</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Notes</strong>
• Ensure the drainage raster is topologically coherent with the D8 grid (both produced from the same DEM).
• The drainage grid and D8 grid must share the same extent, pixel size, and alignment
• NoData and non-stream cells are skipped; only cells marked as stream are traced.
• The resulting lines can be post-processed (e.g., smoothing, ordering, attribute joins) according to project needs.</p>
</blockquote>
<p>The following example demonstrates how to use <code>d8ca</code> tool from the command line:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="hydrological-analysis.html#cb22-1" tabindex="-1"></a><span class="ex">th</span> d8drainagev inputDrainage.tif inputD8.tif outputDrainage.shp</span></code></pre></div>
<p><em>See also</em>: <a href="hydrological-analysis.html#d8">d8</a>, <a href="hydrological-analysis.html#d8ca">d8ca</a>, <a href="hydrological-analysis.html#d8drainage">d8drainage</a>.</p>
</div>
<div id="flowpath" class="section level3 hasAnchor" number="3.2.6">
<h3><span class="header-section-number">3.2.6</span> flowpath<a href="hydrological-analysis.html#flowpath" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>flowpath</code> creates downstream flow paths starting from user-supplied source points and following a D8 flow-direction grid. Each path is routed cell-by-cell along the steepest-descent pointers until it reaches an outlet, a border, or NoData. The result is a raster of flow paths connecting sources to the drainage network/outlet.</p>
<blockquote>
<p><strong>Prerequisites.</strong> Use a hydrologically conditioned DEM to compute <code>d8</code> first. Ensure the source points are in the same CRS as the D8 raster and snapped to the target grid (see notes).</p>
</blockquote>
<p><img src="fig/th_flowpath.png" />
<strong>Figure.</strong> Flow paths (light blue) traced from source points (dark blue dots). Hillshade background.</p>
<hr />
<p><strong>Parameters</strong></p>
<table>
<colgroup>
<col width="14%" />
<col width="85%" />
</colgroup>
<thead>
<tr class="header">
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>d8</code></td>
<td>Input D8 flow-direction raster (GeoTIFF) (e.g., <em>inputD8.tif</em>).</td>
</tr>
<tr class="even">
<td><code>sources</code></td>
<td>Input source points (vector) (e.g., <em>inputSources.shp</em> - one point per initiation site).</td>
</tr>
<tr class="odd">
<td><code>output</code></td>
<td>Output flow paths raster (GeoTIFF) (e.g., <em>outputFlowPaths.tif</em> - 1 = path, 0 = background).</td>
</tr>
</tbody>
</table>
<p>The following example demonstrates how to use <code>flowpath</code> tool from the command line:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb23-1"><a href="hydrological-analysis.html#cb23-1" tabindex="-1"></a><span class="ex">th</span> flowpath inputD8.tif inputSources.shp outputFlowPaths.tif</span></code></pre></div>
<p><strong>Author</strong>: Dr. Henrique Rennó de Azeredo Freitas</p>
<p><em>See also</em>: <a href="hydrological-analysis.html#d8ca">d8ca</a>, <a href="hydrological-analysis.html#d8drainage">d8drainage</a>.</p>
</div>
<div id="segments" class="section level3 hasAnchor" number="3.2.7">
<h3><span class="header-section-number">3.2.7</span> segments<a href="hydrological-analysis.html#segments" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>segments</code> partitions a drainage network (raster) into topologically coherent segments using the D8 flow-direction grid. Each segment receives a unique integer ID so that downstream tools can compute per-segment attributes (length, slope, mean contributing area, etc.) and perform ordering or network analytics.</p>
<p>A drainage segment is the maximal run of connected stream cells whose endpoints match one of the following cases:
1) Headwater (initial point) to confluence (intersection point)<br />
2) Confluence to confluence
3) Confluence to outlet (final point)</p>
<p>Within a segment, there are no intermediate confluences; flow proceeds unbranched following the D8 pointers.</p>
<p><img src="fig/th_segments.png" />
<strong>Figure - Drainage network segmented by unique IDs (colors) between sources, confluences, and outlets</strong>.</p>
<blockquote>
<p><strong>Requirements.</strong> The drainage raster (1 = stream, 0 = non-stream) and the D8 raster must share the same extent, resolution, and alignment, and both must derive from a hydrologically conditioned DEM.</p>
</blockquote>
<hr />
<p><strong>Behavior &amp; data handling</strong>
- Heads/confluences/outlets are detected from the drainage grid using D8 inflow/outflow counts.<br />
- Each resulting segment is written to the output raster with a unique positive integer (background = 0/NoData).<br />
- Single-cell streams are treated as valid segments (headwater directly to outlet/confluence).<br />
- Non-stream and NoData cells are preserved as background.</p>
<hr />
<p><strong>Parameters</strong></p>
<table>
<colgroup>
<col width="15%" />
<col width="84%" />
</colgroup>
<thead>
<tr class="header">
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>d8</code></td>
<td>Input <strong>D8 flow-direction</strong> raster (GeoTIFF) (e.g., <em>inputD8.tif</em>).</td>
</tr>
<tr class="even">
<td><code>--drainage</code></td>
<td>Input <strong>binary drainage</strong> raster (GeoTIFF) (e.g., <em>inputDrainage.tif</em> (1 = stream, 0 = non-stream)).</td>
</tr>
<tr class="odd">
<td><code>-o, --output</code></td>
<td>Output <strong>segment ID</strong> raster (GeoTIFF) (e.g., <em>outputSegments.tif</em> (unique integer per segment)).</td>
</tr>
</tbody>
</table>
<p>The following example demonstrates how to use <code>segments</code> tool from the command line:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb24-1"><a href="hydrological-analysis.html#cb24-1" tabindex="-1"></a><span class="ex">th</span> segments inputD8.tif inputDrainage.tif outputSegments.tif</span></code></pre></div>
<p><em>See also</em>: <a href="hydrological-analysis.html#d8">d8</a>, <a href="hydrological-analysis.html#d8ca">d8ca</a>, <a href="hydrological-analysis.html#d8drainage">d8drainage</a>, <a href="hydrological-analysis.html#minibasins">minibasins</a>.</p>
</div>
<div id="outletbasin" class="section level3 hasAnchor" number="3.2.8">
<h3><span class="header-section-number">3.2.8</span> outletbasin<a href="hydrological-analysis.html#outletbasin" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>outletbasin</code> delineates the contributing basin (upslope area) for a specified outlet cell by tracing cells that drain to that outlet using a D8 flow-direction grid. You provide the outlet’s <strong>row</strong> and <strong>column</strong> indices in the raster; the tool returns a binary basin mask where 1 = inside basin and 0 = outside.</p>
<p><strong>How it works (summary).</strong><br />
Starting at the outlet cell, the algorithm follows D8 pointers <strong>in reverse</strong> (i.e., finds all cells whose flow exits to the outlet through any upstream path). The result is the complete upslope area that contributes flow to the chosen outlet.</p>
<blockquote>
<p><strong>Prerequisites.</strong> Use a hydrologically conditioned DEM to compute D8 directions (<code>d8</code>), typically after pit removal (<code>removepits</code> or <code>simplepits</code> + <code>pfs</code>/<code>pfsd</code>).<br />
<strong>Tip.</strong> Snap the outlet to the stream grid (e.g., from <code>d8drainage</code>) to ensure the selected cell lies on-channel.</p>
</blockquote>
<hr />
<p><strong>Parameters</strong></p>
<table>
<colgroup>
<col width="16%" />
<col width="83%" />
</colgroup>
<thead>
<tr class="header">
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>d8</code></td>
<td>Input D8 flow-direction raster (GeoTIFF) (e.g., <em>inputD8.tif</em>).</td>
</tr>
<tr class="even">
<td><code>inputOutletrow</code></td>
<td>Row index (integer) of the outlet cell to delineate.</td>
</tr>
<tr class="odd">
<td><code>inputOutletcolumn</code></td>
<td>Column index (integer) of the outlet cell to delineate.</td>
</tr>
<tr class="even">
<td><code>output</code></td>
<td>Output outlet basin mask (GeoTIFF; 1 = basin, 0 = non-basin) (e.g., <em>outputOutletbasin.tif</em>).</td>
</tr>
</tbody>
</table>
<p>The following example demonstrates how to use <code>segments</code> tool from the command line:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb25-1"><a href="hydrological-analysis.html#cb25-1" tabindex="-1"></a><span class="ex">th</span> outletbasin inputD8.tif inputOutletrow inputOutletcolumn outputOutletbasin.tif</span></code></pre></div>
<p>Example:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb26-1"><a href="hydrological-analysis.html#cb26-1" tabindex="-1"></a><span class="ex">th</span> outletbasin d8.tif 1453 2078 outlet_basin.tif</span></code></pre></div>
</div>
<div id="mainriver" class="section level3 hasAnchor" number="3.2.9">
<h3><span class="header-section-number">3.2.9</span> mainriver<a href="hydrological-analysis.html#mainriver" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>mainriver</code> extracts the main river of a drainage network by tracing upstream from a user-provided mouth (outlet) cell, following the D8 upstream raster and resolving each confluence toward the branch with the largest contributing area. The result is a binary raster where cells along the main channel are marked as river.</p>
<p><strong>How it works (summary).</strong><br />
Starting at the mouth, the algorithm moves upstream using the <code>d8toupstream</code> grid (which encodes which neighbors flow <strong>into</strong> each cell). At every junction, it consults the contributing area raster (<code>d8ca</code>) to select the dominant branch (largest upslope area) within the drainage mask. This continues until all sources of the main river are traversed, producing a single, continuous main-stem path.</p>
<blockquote>
<p><strong>Prerequisites.</strong><br />
• A hydrologically conditioned DEM used to derive <code>d8</code> → <code>d8ca</code> (contributing area) and <code>d8toupstream</code> (upstream pointers).<br />
• A binary drainage raster (e.g., from <code>d8drainage</code>) aligned with those grids.<br />
• The mouth coordinates (row, column) in a simple text file, typically snapped to a drainage cell.</p>
</blockquote>
<hr />
<p><strong>Parameters</strong></p>
<table>
<colgroup>
<col width="18%" />
<col width="81%" />
</colgroup>
<thead>
<tr class="header">
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>d8upstream</code></td>
<td>Input D8 upstream-pointer raster (GeoTIFF) (e.g., <em>inputD8upstream.tif</em>).</td>
</tr>
<tr class="even">
<td><code>drainage</code></td>
<td>Input binary drainage raster (GeoTIFF) (e.g., <em>inputDrainage.tif</em> (1 = stream, 0 = non-stream)).</td>
</tr>
<tr class="odd">
<td><code>d8ca</code></td>
<td>Input D8 contributing area raster (GeoTIFF) (e.g., <em>inputAccumulatedArea.tif</em>).</td>
</tr>
<tr class="even">
<td><code>mouth</code></td>
<td>Input mouth file (text) with outlet grid coordinates (row, column).</td>
</tr>
<tr class="odd">
<td><code>output</code></td>
<td>Output main river raster (GeoTIFF) (e.g., <em>outputRiver.tif</em> (1 = main river, 0 = elsewhere)).</td>
</tr>
</tbody>
</table>
<p>The following example demonstrates how to use <code>mainriver</code> tool from the command line:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb27-1"><a href="hydrological-analysis.html#cb27-1" tabindex="-1"></a><span class="ex">th</span> mainriver inputD8upstream.tif inputDrainage.tif inputAccumulatedArea.tif inputMouth.txt outputRiver.tif</span></code></pre></div>
</div>
<div id="shreve" class="section level3 hasAnchor" number="3.2.10">
<h3><span class="header-section-number">3.2.10</span> shreve<a href="hydrological-analysis.html#shreve" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>shreve</code> assigns Shreve stream order (also called stream magnitude) to a drainage network using a D8 flow-direction grid, a binary drainage raster, and a text file with headwater (source) cells. In Shreve ordering, every headwater starts with 1, and at each confluence the downstream value is the sum of the upstream magnitudes; values therefore increase monotonically downstream and are proportional to the number of contributing sources.</p>
<p><strong>How it works (summary).</strong><br />
- Initialize all source cells (from <code>inputSources.txt</code>) with 1.<br />
- Traverse the drainage downstream following D8 pointers; when two or more streams merge, sum their magnitudes and write the result to the confluence cell.<br />
- Continue to the outlet, producing an integer magnitude raster over stream cells (background = 0/NoData).</p>
<blockquote>
<p><strong>Use cases.</strong> Shreve magnitude is a convenient topologic weight for channel networks (e.g., highlighting the main stem, ranking segments, or approximating discharge potential). Unlike Strahler order, Shreve values accumulate at every confluence (no resetting), which is useful for network analytics and cartography.</p>
</blockquote>
<hr />
<p><strong>Parameters</strong></p>
<table>
<colgroup>
<col width="15%" />
<col width="84%" />
</colgroup>
<thead>
<tr class="header">
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>d8</code></td>
<td>Input D8 flow-direction raster (GeoTIFF) (e.g., <em>inputD8.tif</em><code>*).                                          | |</code>drainage<code>| Input binary drainage raster (GeoTIFF) (e.g., *inputDrainage.tif* (1 = stream, 0 = non-stream)).        | |</code>sources<code>| Input text file with source (headwater) grid coordinates (row, column), one pair per line.              | |</code>output`</td>
</tr>
</tbody>
</table>
<p>The following example demonstrates how to use <code>shreve</code> tool from the command line:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb28-1"><a href="hydrological-analysis.html#cb28-1" tabindex="-1"></a><span class="ex">th</span> shreve inputD8.tif inputDrainage.tif inputSources.txt outputShreve.tif</span></code></pre></div>
<p><em>Reference</em>:</p>
<p>Shreve, R. L. (1966). Statistical law of stream numbers. The Journal of Geology, 74(1), 17-37. <a href="https://doi.org/10.1086/627137">https://doi.org/10.1086/627137</a></p>
<p><em>See also</em>: <a href="hydrological-analysis.html#strahler">strahler</a>, <a href="hydrological-analysis.html#ottorivers">ottorivers</a>.</p>
</div>
<div id="strahler" class="section level3 hasAnchor" number="3.2.11">
<h3><span class="header-section-number">3.2.11</span> strahler<a href="hydrological-analysis.html#strahler" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>strahler</code> assigns Strahler stream order to a drainage network using a D8 flow-direction grid, a binary drainage raster, and a text file listing headwater (source) cells. In Strahler ordering, every headwater = 1. At a confluence:
- If the upstream orders are equal, the downstream order is one greater (e.g., 2 + 2 → 3).
- If they are different, the downstream order is the maximum of the upstream orders (e.g., 3 + 1 → 3).</p>
<p>This produces an integer order map that highlights network hierarchy and major tributaries.</p>
<p><strong>How it works (summary).</strong><br />
1) Initialize source cells from <code>inputSources.txt</code> with order 1.<br />
2) Traverse downstream along D8 pointers, applying the confluence rules above at each merge.<br />
3) Write the resulting Strahler order to all stream cells (background = 0/NoData).</p>
<blockquote>
<p><strong>Strahler vs. Shreve.</strong> Strahler emphasizes hierarchical structure (orders increase only when equal orders meet). Shreve (magnitude) sums contributions and grows monotonically with the number of sources. Use Strahler for cartographic hierarchy and topology, Shreve for weighting or discharge proxies.</p>
</blockquote>
<hr />
<p><strong>Parameters</strong></p>
<table>
<colgroup>
<col width="15%" />
<col width="84%" />
</colgroup>
<thead>
<tr class="header">
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>d8</code></td>
<td>Input D8 flow-direction raster (GeoTIFF) (e.g., <em>inputD8.tif</em>).</td>
</tr>
<tr class="even">
<td><code>drainage</code></td>
<td>Input binary drainage raster (GeoTIFF) (e.g., <em>inputDrainage.tif</em> (1 = stream, 0 = non-stream)).</td>
</tr>
<tr class="odd">
<td><code>sources</code></td>
<td>Input text file with source (headwater) grid coordinates (row, column), one pair per line.</td>
</tr>
<tr class="even">
<td><code>output</code></td>
<td>Output Strahler order raster (GeoTIFF) (e.g., <em>outputStrahler.tif</em>).</td>
</tr>
</tbody>
</table>
<p>The following example demonstrates how to use <code>strahler</code> tool from the command line:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb29-1"><a href="hydrological-analysis.html#cb29-1" tabindex="-1"></a><span class="ex">th</span> strahler inputD8.tif inputDrainage.tif inputSources.txt outputStrahler.tif</span></code></pre></div>
<p><em>Reference</em>:</p>
<p>Strahler, A. N. (1957). Quantitative analysis of watershed geomorphology. Eos, Transactions American Geophysical Union, 38(6), 913-920. <a href="https://doi.org/10.1029/TR038i006p00913">https://doi.org/10.1029/TR038i006p00913</a></p>
<p><em>See also</em>: <a href="hydrological-analysis.html#shreve">shreve</a>, <a href="hydrological-analysis.html#ottorivers">ottorivers</a>.</p>
</div>
<div id="ottorivers" class="section level3 hasAnchor" number="3.2.12">
<h3><span class="header-section-number">3.2.12</span> ottorivers<a href="hydrological-analysis.html#ottorivers" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>ottorivers</code> assigns hierarchical Otto codes (Pfafstetter-style) to the main river and its principal tributaries using: (i) a D8 upstream raster (<code>d8toupstream</code>), (ii) a binary drainage raster, (iii) a contributing-area raster (<code>d8ca</code>), and (iv) a text file with mouth coordinates. Starting from each mouth, the tool traces the main stem upstream, resolves junctions toward the branch with largest contributing area, and partitions the main stem into a small set of ordered segments while identifying the four major tributaries at that level. The output raster encodes these segments with Otto labels, and a companion text file provides new mouth/source seeds to recurse at the next hierarchical level.</p>
<p><strong>Concept &amp; workflow (summary).</strong><br />
1) For each mouth, follow upstream pointers within the drainage mask; at confluences, select the branch with greater contributing area to continue the main stem.<br />
2) Split the traced main river into five sequential segments (level-k main-stem units) and identify up to four level-k major tributaries entering those segments.<br />
3) Encode main-stem segments and tributaries with Otto codes for level-k, write the otto-coded raster, and export a list of mouths/sources for all coded units to serve as inputs for level-(k+1).</p>
<blockquote>
<p><strong>Notes.</strong> The procedure yields a nested, multi-level river hierarchy consistent with Pfafstetter-type schemes, enabling progressive refinement of the network and seamless linkage with basin Otto coding (<code>ottobasins</code>). Use rasters derived from a hydrologically conditioned DEM.</p>
</blockquote>
<hr />
<p><strong>Parameters</strong></p>
<table>
<colgroup>
<col width="17%" />
<col width="82%" />
</colgroup>
<thead>
<tr class="header">
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>d8upstream</code></td>
<td>Input D8 upstream raster (GeoTIFF) (e.g., <em>inputD8upstream.tif</em>).</td>
</tr>
<tr class="even">
<td><code>drainage</code></td>
<td>Input binary drainage raster (GeoTIFF) (e.g., <em>inputDrainage.tif</em> (1 = stream, 0 = non-stream)).</td>
</tr>
<tr class="odd">
<td><code>d8ca</code></td>
<td>Input D8 contributing area raster (GeoTIFF) (e.g., <em>inputAccumulatedArea.tif</em>).</td>
</tr>
<tr class="even">
<td><code>mouths</code></td>
<td>Input mouths file (text) with outlet grid coordinates (row, column), one pair per line.</td>
</tr>
<tr class="odd">
<td><code>output</code></td>
<td>Output Otto-coded rivers raster (GeoTIFF) (e.g., <em>outputOttoRivers.tif</em>).</td>
</tr>
<tr class="even">
<td><code>--next-level-mouths</code></td>
<td>Output text file with mouths/sources (grid coordinates) for all coded units at this level (e.g., <em>outputNewLevelMouths.txt</em>).</td>
</tr>
</tbody>
</table>
<p>The following example demonstrates how to use <code>ottorivers</code> tool from the command line:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb30-1"><a href="hydrological-analysis.html#cb30-1" tabindex="-1"></a><span class="ex">th</span> ottorivers inputD8upstream.tif inputDrainage.tif inputAccumulatedArea.tif <span class="dt">\</span></span>
<span id="cb30-2"><a href="hydrological-analysis.html#cb30-2" tabindex="-1"></a>              inputMouths.txt outputOttoRivers.tif outputNewLevelMouths.txt</span></code></pre></div>
<p><em>Reference</em>:</p>
<p>Pfafstetter, O. (2014). Classificação de bacias hidrográficas: metodologia de codificação. In Agência Nacional de Águas (Brasil), Codificação de bacias hidrográficas pelo método de Otto Pfafstetter: aplicação na ANA (pp. 25–41). Brasília, DF: Autor. Manuscrito, Anexo I. Available at: <a href="https://capacitacao.ana.gov.br/conhecerh/bitstream/ana/104/1/apostila.pdf">https://capacitacao.ana.gov.br/conhecerh/bitstream/ana/104/1/apostila.pdf</a></p>
<p><em>See also</em>: <a href="hydrological-analysis.html#ottobasins">ottobasins</a>, <a href="hydrological-analysis.html#strahler">strahler</a>, <a href="hydrological-analysis.html#shreve">shreve</a>.</p>
</div>
<div id="mouths" class="section level3 hasAnchor" number="3.2.13">
<h3><span class="header-section-number">3.2.13</span> mouths<a href="hydrological-analysis.html#mouths" class="anchor-section" aria-label="Anchor link to header"></a></h3>
</div>
<div id="orderedmouths" class="section level3 hasAnchor" number="3.2.14">
<h3><span class="header-section-number">3.2.14</span> orderedmouths<a href="hydrological-analysis.html#orderedmouths" class="anchor-section" aria-label="Anchor link to header"></a></h3>

</div>
</div>
<div id="Basin-and-Sub-basin-Delineation" class="section level2 hasAnchor" number="3.3">
<h2><span class="header-section-number">3.3</span> Basin and Sub-basin Delineation<a href="hydrological-analysis.html#Basin-and-Sub-basin-Delineation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li><a href="hydrological-analysis.html#minibasins">minibasins</a><br />
</li>
<li><a href="hydrological-analysis.html#outletbasin">outletbasin</a><br />
</li>
<li><a href="hydrological-analysis.html#ottobasins">ottobasins</a></li>
</ul>
<div id="minibasins" class="section level3 hasAnchor" number="3.3.1">
<h3><span class="header-section-number">3.3.1</span> minibasins<a href="hydrological-analysis.html#minibasins" class="anchor-section" aria-label="Anchor link to header"></a></h3>
</div>
<div id="outletbasin" class="section level3 hasAnchor" number="3.3.2">
<h3><span class="header-section-number">3.3.2</span> outletbasin<a href="hydrological-analysis.html#outletbasin" class="anchor-section" aria-label="Anchor link to header"></a></h3>
</div>
<div id="ottobasins" class="section level3 hasAnchor" number="3.3.3">
<h3><span class="header-section-number">3.3.3</span> ottobasins<a href="hydrological-analysis.html#ottobasins" class="anchor-section" aria-label="Anchor link to header"></a></h3>
</div>
</div>
<div id="Geomorphometric-analysis" class="section level2 hasAnchor" number="3.4">
<h2><span class="header-section-number">3.4</span> Geomorphometric analysis<a href="hydrological-analysis.html#Geomorphometric-analysis" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li><a href="hydrological-analysis.html#tpi">tpi</a><br />
</li>
<li><a href="hydrological-analysis.html#hand">hand</a><br />
</li>
<li><a href="hydrological-analysis.html#sand">sand</a><br />
</li>
<li><a href="hydrological-analysis.html#d8slope">d8slope</a></li>
</ul>
<div id="tpi" class="section level3 hasAnchor" number="3.4.1">
<h3><span class="header-section-number">3.4.1</span> tpi<a href="hydrological-analysis.html#tpi" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>tpi</code> computes the <strong>Topographic Position Index (TPI)</strong>—the difference between the elevation of a focal cell and the mean elevation of its surrounding neighborhood (excluding the focal cell). Positive TPI values indicate local highs (ridges/crests), negative values indicate local lows (valleys/concavities), and values near zero indicate flats or uniform slopes. TPI is scale-dependent: the neighborhood size (window) controls which landforms are emphasized (Weiss, 2001; Jenness, 2006).</p>
<p><strong>Method (moving window).</strong><br />
For each cell, compute the local mean of neighbors within a user-defined SQUARE or CIRCLE window of given size (in cells), then subtract that mean from the focal elevation. Larger windows capture broader landforms; smaller windows highlight fine-scale features (Weiss, 2001; Jenness, 2006).</p>
<p><strong>Interpretation.</strong><br />
• <strong>TPI » 0</strong> → ridges/peaks/crests<br />
• <strong>TPI « 0</strong> → valleys/channels/depressions<br />
• <strong>TPI ≈ 0</strong> → planar or uniformly inclined surfaces</p>
<blockquote>
<p><strong>Notes</strong>
• Choose the window size to match the target landform scale; multi-scale analyses often compute TPI at several sizes (Weiss, 2001).
• The approach popularized by Jenness (2006) operationalized TPI for GIS users and helped standardize classification combining TPI with slope and thresholds (SD-based).
• TPI is dimensionally consistent with the DEM: results are in the same units (e.g., meters).
• The dominance formulation in Muñoz &amp; Valeriano (2014) describes the same concept as the vertical difference to a local average surface.
—</p>
</blockquote>
<p><strong>Parameters</strong></p>
<table>
<colgroup>
<col width="15%" />
<col width="84%" />
</colgroup>
<thead>
<tr class="header">
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>dem</code></td>
<td>Input DEM (GeoTIFF) (e.g., <em>inputDEM.tif</em>).</td>
</tr>
<tr class="even">
<td><code>inputWindowSize</code></td>
<td>Neighborhood window size (in <strong>cells</strong>) used to compute the local mean (scale of analysis).</td>
</tr>
<tr class="odd">
<td><code>SQUARE|CIRCLE</code></td>
<td>Neighborhood shape: <code>SQUARE</code> (square kernel) or <code>CIRCLE</code> (circular kernel).</td>
</tr>
<tr class="even">
<td><code>output</code></td>
<td>Output TPI raster (same elevation units as the DEM) (e.g., <em>outputTPI.tif</em>).</td>
</tr>
</tbody>
</table>
<p>The following example demonstrates how to use <code>tpi</code> tool from the command line:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb31-1"><a href="hydrological-analysis.html#cb31-1" tabindex="-1"></a><span class="ex">th</span> tpi inputDEM.tif inputWindowSize SQUARE<span class="kw">|</span><span class="ex">CIRCLE</span> outputTPI.tif</span></code></pre></div>
<p><em>References</em>:</p>
<p>Jenness, J. (2006). Topographic Position Index (tpi_jen.avx) extension for ArcView 3.x (Version 1.2). Jenness Enterprises. <a href="http://www.jennessent.com/arcview/tpi.htm">http://www.jennessent.com/arcview/tpi.htm</a></p>
<p>Muñoz, V. A., &amp; de Valeriano, M. M. (2014). Mapping of flood-plain by processing of elevation data from remote sensing. In E. Pardo-Igúzquiza, C. Guardiola-Albert, J. Heredia, L. Moreno-Merino, J. Durán, &amp; J. Vargas-Guzmán (Eds.), Mathematics of Planet Earth (Lecture Notes in Earth System Sciences, pp. 543–546). Springer. <a href="https://doi.org/10.1007/978-3-642-32408-6_106">https://doi.org/10.1007/978-3-642-32408-6_106</a></p>
<p>Weiss, A. D. (2001, July). Topographic position and landforms analysis (Poster). ESRI International User Conference, San Diego, CA.</p>
<p><em>See also</em>: <a href="hydrological-analysis.html#hand">hand</a>.</p>
</div>
<div id="hand" class="section level3 hasAnchor" number="3.4.2">
<h3><span class="header-section-number">3.4.2</span> hand<a href="hydrological-analysis.html#hand" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>hand</code> computes the <strong>Height Above the Nearest Drainage (HAND)</strong> (Rennó et al., 2008) for each DEM cell, a terrain descriptor that measures the vertical distance from a cell to its nearest drainage cell along the D8 flow path. By normalizing elevations to the drainage network, HAND highlights local hydrologic gradients (draining potential) and is widely used to delineate valley bottoms, riparian zones, and flood-susceptible areas.</p>
<p><strong>Concept (summary).</strong><br />
Given a hydrologically conditioned DEM, a D8 flow grid, and a drainage mask, each cell is linked to its downstream drainage cell via the D8 path. The HAND value is the DEM elevation difference between the cell and that drainage cell. Drainage cells have HAND = 0 by definition; upland cells have positive values that reflect their relative height above channels. This relative (network-referenced) height often correlates with soil moisture regime and water-table depth in low-relief landscapes.</p>
<blockquote>
<p><strong>Prerequisites.</strong> Use a pitless DEM (e.g., <code>removepits</code>), its D8 directions (<code>d8</code>), and a drainage grid (<code>d8drainage</code>). Ensure rasters share the same extent, resolution, and alignment.</p>
</blockquote>
<p><img src="fig/th_hand.png" /></p>
<p><strong>Figure.</strong> HAND map: drainage cells at 0 m (valley bottoms) and increasing HAND values upslope.
<strong>Figure - HAND calculation scheme</strong>. Drainage-network cells are shown as blue squares, and flow path considers exclusively the black-arrow directions (Source: Rennó et al, 2008).</p>
<hr />
<p><strong>Parameters</strong></p>
<table>
<colgroup>
<col width="16%" />
<col width="83%" />
</colgroup>
<thead>
<tr class="header">
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>dem</code></td>
<td>Input DEM (GeoTIFF) (e.g., <em>inputDEM.tif</em>).</td>
</tr>
<tr class="even">
<td><code>d8</code></td>
<td>Input D8 flow directions (GeoTIFF) (e.g., <em>inputD8.tif</em>).</td>
</tr>
<tr class="odd">
<td><code>drainage</code></td>
<td>Input drainage network (GeoTIFF; 1 = stream, 0 = non-stream) (e.g., <em>inputDrainage.tif</em>).</td>
</tr>
<tr class="even">
<td><code>output</code></td>
<td>Output HAND raster (GeoTIFF) (e.g., <em>outputHAND.tif</em>).</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Notes.</strong><br />
• HAND is relative to the mapped drainage; choosing an appropriate drainage threshold (from d8drainage) affects HAND smoothness and valley width representation.<br />
• Small negative differences caused by noise are typically clamped to 0.
• Derived HAND classes can support terrain zoning (e.g., waterlogged / ecotone / upland) and hydrologic modeling (e.g. classes from highest to lowest susceptibility to flooding).</p>
</blockquote>
<p>The following example demonstrates how to use <code>hand</code> tool from the command line:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb32-1"><a href="hydrological-analysis.html#cb32-1" tabindex="-1"></a><span class="ex">th</span> hand inputDEM.tif inputD8.tif inputDrainage.tif outputHAND.tif</span></code></pre></div>
<p><em>Reference</em>:</p>
<p>Rennó, C. D., Nobre, A. D., Cuartas, L. A., Soares, J. V., Hodnett, M. G., Tomasella, J., &amp; Waterloo, M. J. (2008). HAND, a new terrain descriptor using SRTM-DEM: Mapping terra-firme rainforest environments in Amazonia. Remote Sensing of Environment, 112(9), 3469-3481. <a href="https://doi.org/10.1016/j.rse.2008.03.018">https://doi.org/10.1016/j.rse.2008.03.018</a></p>
<p><em>See also</em>: <a href="hydrological-analysis.html#d8">d8</a>, <a href="hydrological-analysis.html#d8ca">d8ca</a>.</p>
</div>
<div id="sand" class="section level3 hasAnchor" number="3.4.3">
<h3><span class="header-section-number">3.4.3</span> sand<a href="hydrological-analysis.html#sand" class="anchor-section" aria-label="Anchor link to header"></a></h3>
</div>
<div id="d8slope" class="section level3 hasAnchor" number="3.4.4">
<h3><span class="header-section-number">3.4.4</span> d8slope<a href="hydrological-analysis.html#d8slope" class="anchor-section" aria-label="Anchor link to header"></a></h3>

</div>
</div>
<div id="Applied-Hydrology-Risk-Management" class="section level2 hasAnchor" number="3.5">
<h2><span class="header-section-number">3.5</span> Applied Hydrology &amp; Risk Management<a href="hydrological-analysis.html#Applied-Hydrology-Risk-Management" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li><a href="hydrological-analysis.html#gfplain">gfplain</a><br />
</li>
<li><a href="hydrological-analysis.html#damcourse">damcourse</a><br />
</li>
<li><a href="hydrological-analysis.html#damsections">damsections</a><br />
</li>
<li><a href="hydrological-analysis.html#dambreak">dambreak</a></li>
</ul>
<div id="gfplain" class="section level3 hasAnchor" number="3.5.1">
<h3><span class="header-section-number">3.5.1</span> gfplain<a href="hydrological-analysis.html#gfplain" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>gfplain</code> delineates floodplains and computes water height by linking topography to a hydrogeomorphic scaling of channel stage (Nardi et al., 2006, 2019). For each drainage‐network cell, a potential water level is assigned using the stream power law<br />
<span class="math display">\[
h = a \cdot A^{\,b}
\]</span>
where <span class="math inline">\(A\)</span> is the contributing (upslope) area and <span class="math inline">\(a, b\)</span> are empirical parameters. The resulting channel water surface <span class="math inline">\((z + h)\)</span> is then compared against surrounding terrain to flag cells whose elevations are lower than that level as floodplain. This produces (1) a binary floodplain raster and (2) a water-height raster consistent with the selected scaling.</p>
<p><strong>Concept &amp; workflow (summary).</strong><br />
1) Prepare inputs: compute D8 flow directions and contributing area, then derive a drainage mask (e.g., by area threshold).<br />
2) For each stream cell, estimate a water level using the stream power law, and add it to the channel elevation.<br />
3) Map the floodplain as all cells connected to the channel that lie below this water level; also save the resulting water-height grid.</p>
<blockquote>
<p><strong>About the power law parameters.</strong><br />
• <strong><span class="math inline">\(a\)</span> (coefficient)</strong> scales the overall magnitude of stage—larger <span class="math inline">\(a\)</span> yields higher channel levels and broader mapped floodplains for a given <span class="math inline">\(A\)</span>. In practice, <span class="math inline">\(a\)</span> can reflect the event severity (e.g., return period) and reach characteristics and is typically calibrated against observed/benchmark flood extents or hydrodynamic outputs.</p>
</blockquote>
<blockquote>
<p>• <strong><span class="math inline">\(b\)</span> (exponent)</strong> controls how stage grows with river size; empirical studies report positive values that capture hydro-climatic and geomorphic controls (e.g., wider/deeper valleys downstream). Tuning <span class="math inline">\(b\)</span> affects longitudinal consistency of mapped floodplains across orders.</p>
</blockquote>
<p><strong>Figure.</strong> Hydrogeomorphic delineation: (a) D8 and contributing area; (b) stage from <span class="math inline">\(h=aA^b\)</span>; (c) floodplain cells below channel water level.</p>
<hr />
<p><strong>Parameters</strong></p>
<table>
<colgroup>
<col width="17%" />
<col width="82%" />
</colgroup>
<thead>
<tr class="header">
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>dem</code></td>
<td>Input DEM (GeoTIFF) (e.g., <em>inputDEM.tif</em>).</td>
</tr>
<tr class="even">
<td><code>d8</code></td>
<td>Input D8 flow directions (GeoTIFF) (e.g., inputD8.tif*).</td>
</tr>
<tr class="odd">
<td><code>accum</code></td>
<td>Input contributing area raster (GeoTIFF) (e.g., <em>inputContributingArea.tif</em>).</td>
</tr>
<tr class="even">
<td><code>drainage</code></td>
<td>Input drainage network raster (GeoTIFF; 1 = stream, 0 = non-stream), e.g., <code>inputDrainage.tif</code>.</td>
</tr>
<tr class="odd">
<td><code>a</code></td>
<td>Coefficient <span class="math inline">\(a\)</span> in <span class="math inline">\(h=aA^b\)</span>. Sets overall stage magnitude (event/region scale).</td>
</tr>
<tr class="even">
<td><code>b</code></td>
<td>Exponent <span class="math inline">\(b\)</span> in <span class="math inline">\(h=aA^b\)</span>. Controls stage growth with <span class="math inline">\(A\)</span> (network scaling).</td>
</tr>
<tr class="odd">
<td><code>floodplain</code></td>
<td>Output floodplain mask (GeoTIFF; 1 = floodplain) (e.g., <em>outputFloodplain.tif</em>).</td>
</tr>
<tr class="even">
<td><code>waterheight</code></td>
<td>Output water height grid (GeoTIFF) computed from <span class="math inline">\(h=aA^b\)</span> (e.g., <em>outputWaterHeight.tif</em>).</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Notes</strong><br />
• Use a hydrologically conditioned DEM and aligned rasters (same extent/resolution). The drainage mask typically derives from a threshold applied to contributing area.
• Calibrate <span class="math inline">\(a\)</span>, <span class="math inline">\(b\)</span> with local evidence (gauges, reference flood maps, or 2D models) for event-specific applications; defaults may be used for reconnaissance mapping, acknowledging uncertainty.
• The method targets rapid, large-area mapping and complements physics-based simulations; it follows the hydrogeomorphic lineage from Nardi et al. (2006) to the global GFPLAIN framework.</p>
</blockquote>
<p>The following example demonstrates how to use <code>gfplain</code> tool from the command line:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb33-1"><a href="hydrological-analysis.html#cb33-1" tabindex="-1"></a><span class="ex">th</span> gfplain inputDEM.tif inputD8.tif inputContributingArea.tif inputDrainage.tif <span class="dt">\</span></span>
<span id="cb33-2"><a href="hydrological-analysis.html#cb33-2" tabindex="-1"></a>           inputA inputB outputFloodplain.tif outputWaterHeight.tif</span></code></pre></div>
<p><em>Reference</em>:</p>
<p>Nardi, F., Vivoni, E. R. &amp; Grimaldi, S (2006). Investigating a floodplain scaling relation using a hydrogeomorphic delineation method. Water Resources Research, 42, W09409. <a href="https://doi.org/10.1029/2005WR004155">https://doi.org/10.1029/2005WR004155</a></p>
<p>Nardi, F., Annis, A., Di Baldassarre, G., Vivoni, E. R., &amp; Grimaldi, S. (2019). GFPLAIN250m, a global high-resolution dataset of Earth’s floodplains. Sci Data, 6, 180309. <a href="https://doi.org/10.1038/sdata.2018.309">https://doi.org/10.1038/sdata.2018.309</a></p>
<p><em>See also</em>: <a href="hydrological-analysis.html#hand">hand</a>, <a href="hydrological-analysis.html#tpi">tpi</a>.</p>
</div>
<div id="damcourse" class="section level3 hasAnchor" number="3.5.2">
<h3><span class="header-section-number">3.5.2</span> damcourse<a href="hydrological-analysis.html#damcourse" class="anchor-section" aria-label="Anchor link to header"></a></h3>
</div>
<div id="damsections" class="section level3 hasAnchor" number="3.5.3">
<h3><span class="header-section-number">3.5.3</span> damsections<a href="hydrological-analysis.html#damsections" class="anchor-section" aria-label="Anchor link to header"></a></h3>
</div>
<div id="dambreak" class="section level3 hasAnchor" number="3.5.4">
<h3><span class="header-section-number">3.5.4</span> dambreak<a href="hydrological-analysis.html#dambreak" class="anchor-section" aria-label="Anchor link to header"></a></h3>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="introduction.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="how-to-cite.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": null,
    "text": null
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": ["_main.pdf", "_main.epub"],
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  }
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
